<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="ZXing for JS">

    <title>ZXing TypeScript | Decoding from camera stream</title>


</head>

<body>

    <main class="wrapper" style="padding-top:2em">
        <div>
            <button id="startButton">Start</button>
            <button id="resetButton">Reset</button>
        </div>

        <div>
            <video id="video" width="300" height="200" style="border: 1px solid gray; display: none;"></video>
        </div>

        <div id="sourceSelectPanel" style="display:none">
            <select id="sourceSelect" style="max-width:400px">
            </select>
        </div>

        <label>Result:</label>
        <input type="text" id="result"></input>

    </main>

    <script type="text/javascript" src="@zxing/library/umd/index.js"></script>
    <script type="text/javascript">
        window.addEventListener('load', function() {
            let selectedDeviceId;
            const codeReader = new ZXing.BrowserMultiFormatReader()
            console.log('ZXing code reader initialized')
                // promise will exec function in then when cand find listVideoInputDevices else will exec catch

            codeReader.listVideoInputDevices().then(
                    function(videoInputDevices) {

                        const sourceSelect = document.getElementById('sourceSelect')
                        selectedDeviceId = videoInputDevices[videoInputDevices.length - 1].deviceId
                        if (videoInputDevices.length >= 1) {
                            videoInputDevices.forEach((element) => {
                                const sourceOption = document.createElement('option')
                                sourceOption.text = element.label
                                sourceOption.value = element.deviceId
                                sourceSelect.appendChild(sourceOption)
                            })

                            sourceSelect.onchange = () => {
                                selectedDeviceId = sourceSelect.value;
                            };

                            const sourceSelectPanel = document.getElementById('sourceSelectPanel')
                            sourceSelectPanel.style.display = 'block'
                        }

                        document.getElementById('startButton').addEventListener('click', () => {
                            document.getElementById("video").style.display = 'block';
                            codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                                if (result) {
                                    console.log(result);
                                    //document.getElementById('result').textContent = result.text;
                                    document.getElementById('result').value = result.text;
                                    codeReader.reset();
                                    document.getElementById("video").style.display = 'none';
                                    var audio = new Audio('resource/barcode-read.mp3');
                                    audio.play();
                                }
                                if (err && !(err instanceof ZXing.NotFoundException)) {
                                    console.error(err)
                                    document.getElementById('result').textContent = err
                                }
                            })
                            console.log(`Started continous decode from camera with id ${selectedDeviceId}`)
                        })

                        document.getElementById('resetButton').addEventListener('click', () => {
                            codeReader.reset()
                            document.getElementById('result').textContent = '';
                            console.log('Reset.')
                        })

                    })
                .catch(
                    function(err) {
                        console.error(err)
                    })
        })
    </script>

</body>

</html>